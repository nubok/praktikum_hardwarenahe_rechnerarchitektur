\documentclass[10pt]{scrbook}
\usepackage[latin1]{inputenc}
\usepackage{bibgerm}
\usepackage[english, ngerman]{babel}
\usepackage[babel]{csquotes}
\usepackage{cite}
\usepackage{amsmath} % for eqref
\usepackage{tabularx}
\author{Denis Dietze\footnote{denis.dietze@st.ovgu.de} \and Wolfgang Keller\footnote{wolfgang.keller@student.uni-magdeburg.de} \and Nico Linke\footnote{nicolinke@googlemail.com} \and Thomas Schulte\footnote{thomas.schulte.md@googlemail.com}}
\title{Protokoll Versuch IT1/E13}
\subtitle{Schnittstellen}

\begin{document}
\maketitle
\tableofcontents
\chapter{Vorbereitungsaufgaben}

\section{Baugruppen eines Rechners}

\subsection{Frage} Aus welchen Baugruppen besteht ein Rechner ähnlich der von-Neumann-Architektur,
wie sind sie verbunden, und wie erfolgt die Kommunikation mit der Peripherie?

\subsection{Antwort}
Laut \cite[S.~41ff]{Schiffmann} besteht ein Von-Neumann-Rechner aus einem Schaltwerk, Speicher und Eingabe/Ausgabe. Das Schaltwerk besteht hierbei aus Rechenwerk und Leitwerk.

Vom Leitwerk geht ein Adress- und Steuerbus zu den drei anderen Baugruppen. Der Datenbus besteht bidirektional zwischen Speicher zum Rechenwerk, sowie zwischen Rechenwerk und Ein-/Ausgabe. Außerdem besteht eine Datenbusverbindung vom Speicher zum Leitwerk.


\section{Aufgabe von Schnittstellen}

\subsection{Frage} Welche Aufgabe haben Schnittstellen im Rechner?

\subsection{Antwort}
Schnittstellen dienen zum Anschluss von Peripherieger"aten.

\section{Datenaustausch über eine parallele Schnittstelle mit
Handshaking}

\subsection{Frage} Wie funktioniert ein Datenaustausch über eine parallele Schnittstelle mit
Handshaking?

\subsection{Antwort}
Die konkreten Details des Austausch h"angen davon, in welchem Modus der Parallelport betrieben wird. Daher unterscheiden wir drei F"alle:

\begin{itemize}
\item 8255 im Modus 1 (im Modus 0 findet kein Handshaking statt)
\item 8255 im Modus 2
\item Centronics-Schnittstelle
\end{itemize}

\subsubsection{8255 im Modus 1}

Je drei Leitungen des Port PC werden laut \cite[S.~441]{Baehring} den Ports PA und PB als Handshake-Leitungen (\verb|STB|, \verb|ACK| und \verb|INT| zugeordnet. 

\paragraph{Eingabe} Die "Ubertragung beginnt damit, dass das Ger"at ein Datum in \verb|PA0|-\verb|PA7| bzw. \verb|PB0|-\verb|PB7| gelegt wird. Anschließend wird ein kurzes \verb|STB|-Signal erzeugt. Das Ausgangssignal \verb|IBF| zeigt dem Ger"at an, dass das Eingaberegister \verb|IB| noch gef"ullt ist.

\ldots

\subsubsection{Centronics-Schnittstelle}

Laut \cite[S.~447-448]{Baehring} beginnt die "Ubertragung "uber die Centronics-Schnittstelle damit, dass der Prozessor ein Ausgabedatum auf auf die Ausg"ange \verb|DATA1|-\verb|DATA8| der Schnittstelle schaltet. Fr"uhestens $0,5 \mu{}s$ sp"ater wird das \verb|STROBE|-Signal aktiviert, um das Vorliegen eines g"ultigen Datums anzuzeigen.

Anschließend kann das Ger"at die Daten entweder annehmen oder durch Aktivieren eines \verb|BUSY|-Signals anzeigen, dass es besch"aftigt ist. Wenn es bereit ist die Daten anzunehmen, deaktiviert es das \verb|BUSY|-Signal und quittiert die Datenannahme durch ein mindestens $0,5 \mu{}s$ langes \verb|ACKNLG|-Signal.

In \cite[S.~9]{PreussMusa} wird weiter zwischen einem \emph{Dreidraht-Handshake-Protokoll}, was dem soeben Beschriebenen entspricht und einem \emph{Zweidraht-Handshake-Protokoll} unterschieden.

In letzterem bleibt beim Anlegen der Daten auf den Datenleitungen die \verb|STROBE|-Leitung so lange aktiviert, bis der Rechner ein Signal auf der \verb|ACKNOWLEDGE|-Leitung empf"angt. Dieses setzt das \verb|STROBE|-Signal zur"uck und das Peripherieger"at kann neue Daten empfangen.

\section{Funktionsweise einer seriellen Datenübertragung}

\subsection{Frage} Wie funktioniert eine serielle Datenübertragung?

\subsection{Antwort}

Laut \cite[S.~455ff]{Baehring} schreibt der Sender ein auszugebendes Datum in das Sende-Datenregister \verb|TDR|. Von der Bausteinsteuerung wird es automatisch in das Sende-Schieberegister \verb|TSR| "ubertragen. Von der Sende-Synchronisationsschaltung wird das Startbit die Daten-Ausgabeleitung \verb|TxD| gegeben. Anschließend wird durch eine Anzahl Impulse als Sendetakt das Datum Bit f"ur Bit "ubertragen -- mit jedem Takt wird ein Bit aus dem Register auf \verb|TxD| geschoben.

Parallel dazu wird die Parit"at ausgerechnet und nach dem letzten Bit "ubertragen. Nach Abschluss der "Ubertragung erzeugt die Synchronisationsschaltung ein oder mehrere Stoppbits.

Wenn mehrere Daten "ubertragen werden sollen, so wird durch die Ausgangsleitung \verb|TxRDY| dem Prozessor mitgeteilt, dass der Inhalt von \verb|TDR| nach \verb|TSR| "ubertragen wurde.

Der Empfang funktioniert analog: auf eine negative Flanke von \verb|RxD| wird die Empfangs-Synchronisationsschaltung aktiviert. Die folgenden Bits werden in das Empfangs-Schiebe\-register \verb|RSR| eingelesen. Ein empfangenes Datum wird in \verb|RDR| abgelegt. "Uber den Ausgang \verb|RxRDY| teilt der Baustein dem Prozessor mit, wenn in \verb|RDR| ein Datum zur Abholung bereit liegt.

Parallel wird ein Parit"atsbit berechnet. Wenn dieses nicht mit dem "ubertragenen Parit"atsbit "ubereinstimmt, wird im Statusregister ein Parit"atsfehler festgehalten.

Zuletzt wird "uberpr"uft, ob die geforderte Anzahl Stoppbits "ubertragen wurde. Falls dies nicht der Fall ist, wird im Statusregister ein Bit gesetzt (Framing Error). Außerdem wird ebenfalls ein Statusbit gesetzt, wenn ein neues Datum empfangen wird, der Prozessor aber noch nicht das alte abgeholt hat (Overrun Error).

\section{Das Prinzip der Stromschleife}

\subsection{Frage} Erläutern Sie das Prinzip der Stromschleife! Was ist der Vorteil gegenüber einer
spannungsbasierten Übertragung?

\subsection{Antwort}

Die Stromschleife besteht aus einer aktiven (meist PC) und passiven (meist Peripherieger"at) Seite. Wie im Bild in Abschnitt 2.1.2 der Versuchsanleitung zu sehen, wird ein Strom von $20~mA$ "uber diese gesendet, wenn eine logische 1 "ubertragen wird und kein Strom, wenn eine logische 0 "ubertragen wird. Auf der passiven Seite wird durch einen Optokoppler bzw. Relais das Signal ausgewertet.

Der Vorteil gegen"uber einer spannungsbasierten "Ubertragung besteht darin, dass nicht beachtet werden muss, ob die beiden Seite unterschiedliche elektrische Potentiale besitzen, da Sender und Empf"anger voneinander isoliert sind.

\section{Merkmale des PPI 8255}

\subsection{Frage} Nennen Sie wesentliche Merkmale des PPI 8255! Wie funktionieren die
Betriebsarten?

\subsection{Antwort} 3 Betriebsmodi (vgl. \cite[S.~440-447]{Baehring})
\begin{itemize}
\item Modus 0
\item Modus 1
\item Modus 2
\end{itemize}

\subsubsection{Modus 0}

\begin{itemize}
\item Port \verb|PC| in zwei Teilports $\verb|PC|_{\verb|H|}$ und $\verb|PC|_{\verb|L|}$ aufgeteilt
\item Jeder Teilport als paralleler Ein-/Ausgabeport mit immer selben "Ubertragungsrichtung (wird f"ur jeden der \verb|PA|, \verb|PB| $\verb|PC|_{\verb|H|}$ und $\verb|PC|_{\verb|L|}$ im Steuerwort individuell festgelegt)
\end{itemize}

\subsubsection{Modus 1}

\begin{itemize}
\item Je drei Leitungen von \verb|PC| werden \verb|PA| und \verb|PB| als Handshake-Leitungen zugeordnet
\item Restliche beiden Leitungen von \verb|PC| werden \verb|PA| zugeordnet
\end{itemize}

\subsubsection{Modus 2}


\begin{itemize}
\item Von Port \verb|PC| werden drei Leitungen \verb|PB| zugeordnet
\item \verb|PB| entweder Ein- oder Ausgangsport
\item Die drei Leitungen von \verb|PC| wahlweise f"ur E/A oder Handshake
\item Restliche f"unf Leitungen von \verb|PC| f"ur Handshake von \verb|PA| (erlaubt bidirektionale "Ubertragung im Halbduplex-Modus)
\end{itemize}

\section{Interruptverarbeitung im PC}

\subsection{Frage} Wie ist die Interruptverarbeitung im PC organisiert? Wie sind CPU,
Interruptcontroller und -quellen miteinander verschaltet? Wie funktioniert
Vektorinterrupt?

\subsection{Antwort} \ldots (Antwort bekannt -- zu faul jetzt aufzuschreiben)

\section{Hardware- vs. Software-Interrupts}

\subsection{Frage}
Was unterscheidet Hardware- von Software-Interrupts, was haben sie gemeinsam?

\subsection{Antwort}
Hardware-Interrupts werden durch ein Peripherie-Ger"at ausgel"ost, w"ahrend Software-Interrupts durch einen \verb|INT|-Befehl ausgel"ost werden.

In beiden F"allen wird laut \cite[S.~107]{althaus}  der Wert des Stack Pointers \verb|SP| und des Flag-Registers auf dem Stack gesichert und der dem Interrupt zugeh"orige Wert aus der Interrupt-Einsprungtabelle in den Program Counter \verb|PC| geladen.

Somit stellen Software-Interrupts eine Art Funktionsaufruf dar, bei dem zus"atzlich das Flag-Register gesichert und wiederhergestellt wird, w"ahrend Hardware-Interrupts eine asynchrone Unterbrechung des Programmablaufs darstellen.

\section{M"oglichkeiten der Schnittstellenkonfigurierung}

\subsection{Frage} Informieren Sie sich über M"oglichkeiten der Schnittstellenkonfigurierung. Welche
Rolle spielen dabei Softwareinterrupts?

\subsection{Antwort}

(vgl. Versuchsbeschreibung, Abschnitt 2.4):
\begin{itemize}
\item Direkter Zugriff im E/A-Adressraum
\item Verwendung von BIOS-Interrupts
\item Verwendung von DOS-Interrupts
\end{itemize}

Letztere beide M"ochlichkeiten sind Softwareinterrupts.

\section{Befehle zum Zugriff auf Ein-/Ausgabe-Baugruppen}

\subsection{Frage} Wiederholen Sie die Syntax des 80x86-Assemblers (siehe Anlage 12 der Versuchsanleitung). Mit welchen
Befehlen wird auf die Ein-/Ausgabe-Baugruppen zugegriffen?

\subsection{Antwort} Die Befehle zum Zugriff auf Ports sind \verb|IN| zum Einlesen und \verb|OUT| zum Ausgeben eines Wertes aus einem Port. Außerdem sind viele Baugruppen unter DOS "uber Interrupts ansteuerbar, wie in Anlagen 3-5 der Versuchsanleitung bez"uglich Interrupt 14h, 15h bzw. 21h f"ur die serielle bzw. parallele Schnittstelle. In diesem Fall erfolgt der Zugriff durch Belegen der Prozessorregister mit den gew"unschten Werten gefolgt von einem \verb|INT|-Befehl.

\chapter{Aufgaben und Auswertung}

\section{Aufgabe 1a}

\paragraph{Aufgabenstellung} Ab Adresse Segment:Offset=0:410h speichert das Betriebssystem das
Systemkonfigurations-Wort (16 Bit) ab. Bits 15 und 14 enthalten die Anzahl der
parallelen und Bits 9 und 10 die Anzahl der seriellen Ports. Ab Adresse 0:400h stehen die
Basisadressen von COM1 und COM2 und ab Adresse 0:408h die Basisadressen von
LPT1-3 (jeweils 16 Bit). Zeigen Sie die Werte mit <d> an. Notieren Sie sich die Werte.

\paragraph{Durchf"uhrung} alle folgenden Ausgaben notieren:

\begin{verbatim}
d0:410 l 2 (Systemkonfigurations-Wort)
\end{verbatim}

\paragraph{Auswertung}
\begin{itemize}
\item Bit 1, 2 von 0:411h (Bit 9, 10 des Systemkonfigurations-Worts): Anzahl serieller Ports
\item Bit 7, 8 von 0:411h (Bit 14, 15 des Systemkonfigurations-Worts): Anzahl paralleler Ports
\end{itemize}

\begin{verbatim}
d0:400 l 2 (Basisadresse COM1)

d0:402 l 2 (Basisadresse COM2)

d0:408 l 2 (Basisadresse LPT1)

d0:40A l 2 (Basisadresse LPT2)

d0:40C l 2 (Basisadresse LPT3)
\end{verbatim}

\section{Aufgabe 1b}

\paragraph{Aufgabenstellung} Auf welcher Speicheradresse befindet sich der Interruptvektor von IRQ 7 und welchen
Wert hat er? Vergleichen Sie den Wert, wie er mit 'si' angezeigt wird, mit der Anzeige in
'debug'. Lassen Sie sich die Interrupt-Serviceroutine als Assemblercode anzeigen
(Befehl \textless u\textgreater ).

\paragraph{Durchf"uhrung} Laut Tabelle 9 der Versuchsanleitung hat IRQ 7 die Nummer INT 0F. Da die Interruptvektortabelle an an der Adresse 0:0 beginnt und jeder Eintrag vier Bytes lang ist, liegt der Interruptvektor von IRQ 7 an der Speicheradresse \verb|3C|.

Um den Wert anzuzeigen, benutzen wir also

\begin{verbatim}
d0:3C l 4
\end{verbatim}

Ausgabe ist in Segment:Offset (also Segment [d0:3F][d0:3E], Offset [d0:3D][d0:3C]).

\paragraph{Vermutung} In 'si' wird es
\begin{itemize}
\item als direkte Speicheradresse (Segment*10h+Offset)
\item in Big-Endian-Schreibweise
\end{itemize}
dargestellt.

Um den Assemblercode anzuzeigen, benutzen wir
\begin{verbatim}
U Segment:Offset
\end{verbatim}

\section{Aufgabe 2}

\paragraph{Aufgabenstellung} Initialisieren Sie den PPI 8255 der E/A-Karte PIO-12 im Mode 1 (Portadressen siehe
Anlagen 6 und 8) für Byteeingabe Port A, Byteausgabe Port B mit Handshaking-
Protokoll an Port C. Ermitteln Sie die notwendigen Steuerworte anhand Anlage 7 und
geben Sie diese mit Hilfe des DOS-Debuggers auf die Steuerwortaderesse des PPI aus
(Befehlsübersicht in Anlage 2). Simulieren Sie einen asynchronen Datenaustausch mit
Hilfe der Leuchtdioden und Schalter des Steuerpults, indem Sie mit dem Debugger Einund
Ausgaben durchführen. Stellen Sie das Signalspiel auf dem Digitaloszilloskop dar
(Digitalmodus, Ablenkung ca. 1-2 s).


\paragraph{Durchf"uhrung}
Um auf Mode 1 mit den gew"unschten Eigenschaften zu wechseln, m"ussen wir das Control Word auf \verb|1011?10?| setzen. Da das Steuerwort die Adresse \verb|303h| (?) hat, ergibt sich somit:

\begin{verbatim}
e0:303 ...
\end{verbatim}

\section{Aufgabe 3}

Interrupt-Service-Routine

\begin{verbatim}
push ax
push dx
mov dx, PORT_A_ADRESSE ; 301?
in dx, al 
mov dx, PORT_B_ADRESSE
out dx, al
mov al, 20 ; Ruecksetzbefehl des PIC (EOI)
mov dx, 20 ; Portadresse PIC
out dx, al
pop dx
pop ax
iret
\end{verbatim}

\section{Aufgabe 5}

\paragraph{Aufgabe} Geben Sie mit Hilfe von BIOS-Funktionen Daten vom PC über die serielle Schnittstelle
auf das A/N-Display aus. Beachten Sie die notwendige Initialisierung der seriellen
Schnittstelle (2400 Baud, 8 Bit Daten). Stellen Sie das Datentelegramm auf dem
Oszilloskop dar (Digitalmodus, Ablenkung ca. 1 ms) und protokollieren Sie es.

\paragraph{Durchf"uhrung}

Programm 

\begin{verbatim}
mov ah, 00h ; Initialisiere Schnittstelle
mov dx, 0   ; 0: COM1, 1: COM2
mov al, a7h
int 14
mov ah, 01h ; Sende Zeichen
mov dx, 0   ; 0: COM1, 1: COM2
mov al, ZEICHEN
int 14
; Ggf. fuer weitere Zeichen fortsetzen
\end{verbatim}

\paragraph{Zusatzaufgabe} Wiederholen Sie die Datenübertragung unter Verwendung der
Stromschleife!

\bibliography{E13}{}
\bibliographystyle{geralpha}

\end{document}